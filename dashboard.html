<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reports | PlainFinance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231e3a5f'/><text x='50' y='65' font-size='50' fill='white' text-anchor='middle' font-family='Arial'>PF</text></svg>">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav nav-dashboard">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span class="logo-text">PlainFinance</span>
            </a>
            <div class="nav-links">
                <a href="dashboard.html" class="active">My Reports</a>
                <a href="analyze.html">New Analysis</a>
                <div class="nav-user">
                    <span id="userName">User</span>
                    <button class="btn btn-secondary btn-sm" onclick="signOut()">Log Out</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-main">
        <div class="dashboard-container">
            <!-- Header -->
            <header class="dashboard-header">
                <div>
                    <h1>My Reports</h1>
                    <p>View and manage your financial reports</p>
                </div>
                <a href="analyze.html" class="btn btn-primary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Report
                </a>
            </header>

            <!-- Reports List -->
            <div class="reports-section">
                <div class="reports-list" id="reportsList">
                    <!-- Loading state -->
                    <div class="loading-state" id="loadingState">
                        <div class="loading-spinner"></div>
                        <p>Loading your reports...</p>
                    </div>
                </div>

                <!-- Empty state -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <h2>No reports yet</h2>
                    <p>Create your first financial report to get started.</p>
                    <a href="analyze.html" class="btn btn-primary">Create Your First Report</a>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        // Check authentication
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await getUser();

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Update user name
            const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
            document.getElementById('userName').textContent = userName;

            // Load reports
            await loadReports();
        });

        async function loadReports() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const reportsList = document.getElementById('reportsList');

            const { data: reports, error } = await getUserReports();

            loadingState.style.display = 'none';

            if (error) {
                reportsList.innerHTML = `<p class="error-message">Failed to load reports. Please try again.</p>`;
                return;
            }

            if (!reports || reports.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            reportsList.innerHTML = reports.map(report => {
                const period = `${monthNames[parseInt(report.period_month) - 1] || ''} ${report.period_year || ''}`;
                const createdDate = new Date(report.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const profitClass = report.net_profit >= 0 ? 'positive' : 'negative';
                const profitSign = report.net_profit >= 0 ? '+' : '';

                return `
                    <div class="report-card" data-id="${report.id}">
                        <div class="report-card-header">
                            <div class="report-company">${report.company_name || 'Unknown Company'}</div>
                            <div class="report-period">${period}</div>
                        </div>
                        <div class="report-card-metrics">
                            <div class="report-metric">
                                <span class="metric-label">Revenue</span>
                                <span class="metric-value">${report.currency || 'AED'} ${formatNumber(report.revenue)}</span>
                            </div>
                            <div class="report-metric">
                                <span class="metric-label">Net Profit</span>
                                <span class="metric-value ${profitClass}">${profitSign}${report.currency || 'AED'} ${formatNumber(report.net_profit)}</span>
                            </div>
                            <div class="report-metric">
                                <span class="metric-label">Cash</span>
                                <span class="metric-value">${report.currency || 'AED'} ${formatNumber(report.cash)}</span>
                            </div>
                        </div>
                        <div class="report-card-footer">
                            <span class="report-date">Created ${createdDate}</span>
                            <div class="report-actions">
                                <button class="btn btn-sm btn-secondary" onclick="viewReport('${report.id}')">View</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${report.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return Math.abs(num).toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        async function viewReport(reportId) {
            const { data, error } = await getReport(reportId);

            if (error || !data) {
                alert('Failed to load report');
                return;
            }

            // Store report data and redirect
            localStorage.setItem('plainfinance_report', JSON.stringify(data.report_data));
            window.location.href = 'report.html';
        }

        async function confirmDelete(reportId) {
            if (!confirm('Are you sure you want to delete this report? This cannot be undone.')) {
                return;
            }

            const { error } = await deleteReport(reportId);

            if (error) {
                alert('Failed to delete report');
                return;
            }

            // Reload reports
            await loadReports();
        }
    </script>
</body>
</html>
