<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reports | PlainFinancials</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231e3a5f'/><text x='50' y='65' font-size='50' fill='white' text-anchor='middle' font-family='Arial'>PF</text></svg>">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav nav-dashboard">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span class="logo-text">PlainFinancials</span>
            </a>
            <div class="nav-links">
                <a href="dashboard.html" class="active">My Reports</a>
                <a href="analyze.html">New Analysis</a>
                <div class="nav-user">
                    <span id="userName">User</span>
                    <button class="btn btn-secondary btn-sm" onclick="signOut()">Log Out</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-main">
        <div class="dashboard-container">
            <!-- Subscription Banner -->
            <div class="subscription-banner" id="subscriptionBanner" style="display: none;">
                <div class="subscription-info">
                    <span class="plan-badge" id="planBadge">Free</span>
                    <span class="reports-count" id="reportsCount"></span>
                </div>
                <a href="pricing.html" class="btn btn-sm btn-primary" id="upgradeBtn">Upgrade</a>
            </div>

            <!-- Pro Features Section -->
            <div class="pro-features" id="proFeatures" style="display: none;">
                <!-- Branding Section -->
                <div class="pro-card branding-section">
                    <h3>Your Brand</h3>
                    <p>Upload your logo for branded PDF reports</p>
                    <div class="logo-upload-area">
                        <div class="current-logo" id="currentLogo">
                            <span class="no-logo">No logo uploaded</span>
                        </div>
                        <div class="logo-actions">
                            <input type="file" id="logoInput" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('logoInput').click()">
                                Upload Logo
                            </button>
                            <button class="btn btn-sm" onclick="removeLogo()" id="removeLogoBtn" style="display: none;">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Team Section -->
                <div class="pro-card team-section">
                    <h3>Team Access</h3>
                    <p>Invite team members to view your reports (up to 5)</p>

                    <div class="team-members" id="teamMembers">
                        <!-- Team members will be listed here -->
                    </div>

                    <div class="invite-form" id="inviteForm">
                        <input type="email" id="inviteEmail" placeholder="colleague@company.com">
                        <button class="btn btn-primary btn-sm" onclick="inviteTeamMember()">
                            Invite
                        </button>
                    </div>

                    <div id="inviteStatus" class="invite-status"></div>
                </div>
            </div>

            <!-- Header -->
            <header class="dashboard-header">
                <div>
                    <h1>My Reports</h1>
                    <p>View and manage your financial reports</p>
                </div>
                <a href="analyze.html" class="btn btn-primary" id="newReportBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Report
                </a>
            </header>

            <!-- Trends Section (shown when 2+ reports exist) -->
            <div class="trends-section" id="trendsSection" style="display: none;">
                <h2>Your Business Trends</h2>
                <p class="section-subtitle">How your key metrics have changed over time</p>

                <div class="trends-summary" id="trendsSummary">
                    <div class="trend-card">
                        <span class="trend-label">Revenue Trend</span>
                        <span class="trend-value" id="revenueTrend">-</span>
                    </div>
                    <div class="trend-card">
                        <span class="trend-label">Profit Trend</span>
                        <span class="trend-value" id="profitTrend">-</span>
                    </div>
                    <div class="trend-card">
                        <span class="trend-label">Cash Trend</span>
                        <span class="trend-value" id="cashTrend">-</span>
                    </div>
                </div>

                <div class="trends-chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- Reports List -->
            <div class="reports-section">
                <div class="reports-list" id="reportsList">
                    <!-- Loading state -->
                    <div class="loading-state" id="loadingState">
                        <div class="loading-spinner"></div>
                        <p>Loading your reports...</p>
                    </div>
                </div>

                <!-- Empty state -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <h2>No reports yet</h2>
                    <p>Create your first financial report to get started.</p>
                    <a href="analyze.html" class="btn btn-primary">Create Your First Report</a>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        // Check authentication
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await getUser();

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // Update user name
            const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
            document.getElementById('userName').textContent = userName;

            // Load subscription info
            await loadSubscriptionInfo();

            // Load reports
            await loadReports();
        });

        async function loadSubscriptionInfo() {
            const banner = document.getElementById('subscriptionBanner');
            const planBadge = document.getElementById('planBadge');
            const reportsCount = document.getElementById('reportsCount');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const newReportBtn = document.getElementById('newReportBtn');

            try {
                const reportCheck = await canCreateReport();
                banner.style.display = 'flex';

                const planNames = {
                    'free': 'Free',
                    'owner': 'Owner',
                    'pro': 'Pro'
                };

                planBadge.textContent = planNames[reportCheck.plan] || 'Free';
                planBadge.className = 'plan-badge plan-' + reportCheck.plan;

                if (reportCheck.plan === 'free') {
                    // Free tier - lifetime limit
                    reportsCount.textContent = `${reportCheck.remaining} of ${reportCheck.limit} free reports remaining`;

                    if (reportCheck.remaining === 0) {
                        newReportBtn.classList.add('disabled');
                        newReportBtn.onclick = (e) => {
                            e.preventDefault();
                            if (confirm('You have used your 2 free reports. Upgrade to Owner for 6 reports per month.')) {
                                window.location.href = 'pricing.html';
                            }
                        };
                    }
                } else {
                    // Paid tier - monthly limit
                    reportsCount.textContent = `${reportCheck.remaining} of ${reportCheck.limit} reports remaining this month`;
                    upgradeBtn.style.display = reportCheck.plan === 'pro' ? 'none' : 'inline-flex';
                }
            } catch (e) {
                console.log('Could not load subscription info');
            }
        }

        async function loadReports() {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const reportsList = document.getElementById('reportsList');

            const { data: reports, error } = await getUserReports();

            loadingState.style.display = 'none';

            if (error) {
                reportsList.innerHTML = `<p class="error-message">Failed to load reports. Please try again.</p>`;
                return;
            }

            if (!reports || reports.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            // Show trends if 2+ reports
            if (reports.length >= 2) {
                renderTrends(reports);
            }

            reportsList.innerHTML = reports.map(report => {
                const period = `${monthNames[parseInt(report.period_month) - 1] || ''} ${report.period_year || ''}`;
                const createdDate = new Date(report.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const profitClass = report.net_profit >= 0 ? 'positive' : 'negative';
                const profitSign = report.net_profit >= 0 ? '+' : '';

                return `
                    <div class="report-card" data-id="${report.id}">
                        <div class="report-card-header">
                            <div class="report-company">${report.company_name || 'Unknown Company'}</div>
                            <div class="report-period">${period}</div>
                        </div>
                        <div class="report-card-metrics">
                            <div class="report-metric">
                                <span class="metric-label">Revenue</span>
                                <span class="metric-value">${report.currency || 'AED'} ${formatNumber(report.revenue)}</span>
                            </div>
                            <div class="report-metric">
                                <span class="metric-label">Net Profit</span>
                                <span class="metric-value ${profitClass}">${profitSign}${report.currency || 'AED'} ${formatNumber(report.net_profit)}</span>
                            </div>
                            <div class="report-metric">
                                <span class="metric-label">Cash</span>
                                <span class="metric-value">${report.currency || 'AED'} ${formatNumber(report.cash)}</span>
                            </div>
                        </div>
                        <div class="report-card-footer">
                            <span class="report-date">Created ${createdDate}</span>
                            <div class="report-actions">
                                <button class="btn btn-sm btn-secondary" onclick="viewReport('${report.id}')">View</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${report.id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return Math.abs(num).toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        async function viewReport(reportId) {
            const { data, error } = await getReport(reportId);

            if (error || !data) {
                alert('Failed to load report');
                return;
            }

            // Store report data and redirect
            localStorage.setItem('plainfinance_report', JSON.stringify(data.report_data));
            window.location.href = 'report.html';
        }

        async function confirmDelete(reportId) {
            if (!confirm('Are you sure you want to delete this report? This cannot be undone.')) {
                return;
            }

            const { error } = await deleteReport(reportId);

            if (error) {
                alert('Failed to delete report');
                return;
            }

            // Reload reports
            await loadReports();
        }

        function renderTrends(reports) {
            const trendsSection = document.getElementById('trendsSection');
            trendsSection.style.display = 'block';

            // Sort reports by period (oldest first)
            const sortedReports = [...reports].sort((a, b) => {
                const dateA = new Date(a.period_year, parseInt(a.period_month) - 1);
                const dateB = new Date(b.period_year, parseInt(b.period_month) - 1);
                return dateA - dateB;
            }).slice(-6); // Last 6 reports max

            // Prepare data
            const labels = sortedReports.map(r => {
                const monthShort = monthNames[parseInt(r.period_month) - 1]?.substring(0, 3) || '';
                return `${monthShort} ${r.period_year?.toString().slice(-2) || ''}`;
            });

            const revenueData = sortedReports.map(r => r.revenue || 0);
            const profitData = sortedReports.map(r => r.net_profit || 0);
            const cashData = sortedReports.map(r => r.cash || 0);

            // Calculate trends (comparing latest to earliest)
            const calcTrend = (data) => {
                if (data.length < 2) return { text: '-', class: '' };
                const first = data[0] || 1;
                const last = data[data.length - 1];
                const change = ((last - first) / Math.abs(first)) * 100;
                const arrow = change >= 0 ? '↑' : '↓';
                const cls = change >= 0 ? 'positive' : 'negative';
                return { text: `${arrow} ${Math.abs(change).toFixed(0)}%`, class: cls };
            };

            const revenueTrend = calcTrend(revenueData);
            const profitTrend = calcTrend(profitData);
            const cashTrend = calcTrend(cashData);

            document.getElementById('revenueTrend').textContent = revenueTrend.text;
            document.getElementById('revenueTrend').className = `trend-value ${revenueTrend.class}`;
            document.getElementById('profitTrend').textContent = profitTrend.text;
            document.getElementById('profitTrend').className = `trend-value ${profitTrend.class}`;
            document.getElementById('cashTrend').textContent = cashTrend.text;
            document.getElementById('cashTrend').className = `trend-value ${cashTrend.class}`;

            // Render chart
            const ctx = document.getElementById('trendsChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Net Profit',
                            data: profitData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Cash',
                            data: cashData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: AED ${formatNumber(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ===== Branding / Logo Upload (Pro Only) =====

        async function initBranding() {
            const brandingSection = document.getElementById('brandingSection');
            if (!brandingSection) return;

            // Check if Pro user
            const { data: profile } = await getUserProfile();
            const plan = profile?.subscription_plan || 'free';

            if (plan === 'pro') {
                brandingSection.style.display = 'block';
                loadCurrentLogo();
                setupLogoUpload();
            }
        }

        function setupLogoUpload() {
            const logoInput = document.getElementById('logoInput');
            if (!logoInput) return;

            logoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file
                if (!file.type.startsWith('image/')) {
                    alert('Please upload an image file');
                    return;
                }

                if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    alert('Logo must be less than 2MB');
                    return;
                }

                await uploadLogo(file);
            });
        }

        async function uploadLogo(file) {
            const client = getSupabase();
            if (!client) return;

            const user = await getUser();
            if (!user) return;

            const fileExt = file.name.split('.').pop();
            const fileName = `${user.id}/logo.${fileExt}`;

            try {
                // Upload to Supabase storage
                const { data, error } = await client.storage
                    .from('logos')
                    .upload(fileName, file, { upsert: true });

                if (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload logo. Please try again.');
                    return;
                }

                // Get public URL
                const { data: urlData } = client.storage
                    .from('logos')
                    .getPublicUrl(fileName);

                // Save URL to profile
                await client.from('profiles').update({
                    logo_url: urlData.publicUrl
                }).eq('id', user.id);

                // Update display
                displayLogo(urlData.publicUrl);
                alert('Logo uploaded successfully!');

            } catch (error) {
                console.error('Logo upload error:', error);
                alert('Failed to upload logo');
            }
        }

        async function loadCurrentLogo() {
            const { data: profile } = await getUserProfile();
            if (profile?.logo_url) {
                displayLogo(profile.logo_url);
            }
        }

        function displayLogo(url) {
            const container = document.getElementById('currentLogo');
            container.innerHTML = `<img src="${url}" alt="Your logo" style="max-width: 150px; max-height: 80px; object-fit: contain;">`;
            document.getElementById('removeLogoBtn').style.display = 'inline-flex';
        }

        async function removeLogo() {
            const client = getSupabase();
            if (!client) return;

            const user = await getUser();
            if (!user) return;

            try {
                // Remove from profile
                await client.from('profiles').update({
                    logo_url: null
                }).eq('id', user.id);

                // Update display
                document.getElementById('currentLogo').innerHTML = '<span class="no-logo">No logo uploaded</span>';
                document.getElementById('removeLogoBtn').style.display = 'none';
                alert('Logo removed');
            } catch (error) {
                console.error('Remove logo error:', error);
            }
        }

        // Initialize branding section
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initProFeatures, 100);
        });

        // ===== Pro Features Initialization =====

        async function initProFeatures() {
            const proFeaturesSection = document.getElementById('proFeatures');
            if (!proFeaturesSection) return;

            // Check if Pro user
            const { data: profile } = await getUserProfile();
            const plan = profile?.subscription_plan || 'free';

            if (plan === 'pro') {
                proFeaturesSection.style.display = 'block';
                loadCurrentLogo();
                setupLogoUpload();
                loadTeamMembers();
            }
        }

        // ===== Team Access (Pro Only) =====

        async function loadTeamMembers() {
            const container = document.getElementById('teamMembers');
            if (!container) return;

            const client = getSupabase();
            if (!client) return;

            const user = await getUser();
            if (!user) return;

            try {
                // Get user's team
                const { data: profile } = await client
                    .from('profiles')
                    .select('team_id')
                    .eq('id', user.id)
                    .single();

                if (!profile?.team_id) {
                    // User doesn't have a team yet, create one
                    container.innerHTML = '<p class="team-empty">No team members yet. Invite your first colleague above.</p>';
                    return;
                }

                // Get team members
                const { data: members, error } = await client
                    .from('team_members')
                    .select('id, invited_email, status, user_id, created_at')
                    .eq('team_id', profile.team_id);

                if (error) throw error;

                if (!members || members.length === 0) {
                    container.innerHTML = '<p class="team-empty">No team members yet. Invite your first colleague above.</p>';
                    return;
                }

                container.innerHTML = members.map(member => {
                    const statusClass = member.status === 'active' ? 'active' : 'pending';
                    const statusText = member.status === 'active' ? 'Active' : 'Pending';
                    return `
                        <div class="team-member" data-id="${member.id}">
                            <div class="member-info">
                                <span class="member-email">${member.invited_email}</span>
                                <span class="member-status ${statusClass}">${statusText}</span>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="removeTeamMember('${member.id}')">Remove</button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Load team error:', error);
                container.innerHTML = '<p class="team-error">Failed to load team members.</p>';
            }
        }

        async function inviteTeamMember() {
            const emailInput = document.getElementById('inviteEmail');
            const statusDiv = document.getElementById('inviteStatus');
            const email = emailInput.value.trim().toLowerCase();

            if (!email || !email.includes('@')) {
                statusDiv.innerHTML = '<span class="status-error">Please enter a valid email</span>';
                return;
            }

            statusDiv.innerHTML = '<span class="status-loading">Sending invite...</span>';

            const client = getSupabase();
            if (!client) return;

            const user = await getUser();
            if (!user) return;

            try {
                // First, ensure user has a team
                let { data: profile } = await client
                    .from('profiles')
                    .select('team_id')
                    .eq('id', user.id)
                    .single();

                let teamId = profile?.team_id;

                if (!teamId) {
                    // Create team for user
                    const { data: team, error: teamError } = await client
                        .from('teams')
                        .insert({
                            name: `${user.email}'s Team`,
                            owner_id: user.id
                        })
                        .select()
                        .single();

                    if (teamError) throw teamError;
                    teamId = team.id;

                    // Update user's profile with team_id
                    await client.from('profiles').update({ team_id: teamId }).eq('id', user.id);
                }

                // Check team member limit (max 5)
                const { data: existingMembers } = await client
                    .from('team_members')
                    .select('id')
                    .eq('team_id', teamId);

                if (existingMembers && existingMembers.length >= 5) {
                    statusDiv.innerHTML = '<span class="status-error">Maximum 5 team members allowed</span>';
                    return;
                }

                // Check if already invited
                const { data: existing } = await client
                    .from('team_members')
                    .select('id')
                    .eq('team_id', teamId)
                    .eq('invited_email', email)
                    .maybeSingle();

                if (existing) {
                    statusDiv.innerHTML = '<span class="status-error">This email is already invited</span>';
                    return;
                }

                // Add team member invitation
                const { error: inviteError } = await client
                    .from('team_members')
                    .insert({
                        team_id: teamId,
                        invited_email: email,
                        status: 'pending',
                        role: 'member'
                    });

                if (inviteError) throw inviteError;

                // Success
                statusDiv.innerHTML = '<span class="status-success">Invitation sent!</span>';
                emailInput.value = '';

                // Reload team list
                await loadTeamMembers();

                // Clear status after 3 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Invite error:', error);
                statusDiv.innerHTML = '<span class="status-error">Failed to send invite. Please try again.</span>';
            }
        }

        async function removeTeamMember(memberId) {
            if (!confirm('Remove this team member?')) return;

            const client = getSupabase();
            if (!client) return;

            try {
                const { error } = await client
                    .from('team_members')
                    .delete()
                    .eq('id', memberId);

                if (error) throw error;

                // Reload team list
                await loadTeamMembers();

            } catch (error) {
                console.error('Remove member error:', error);
                alert('Failed to remove team member');
            }
        }
    </script>
</body>
</html>
